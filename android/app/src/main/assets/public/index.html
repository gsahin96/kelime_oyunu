<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YETI Kelime Oyunu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        .hidden { display: none; }
        .player-slot { 
            transition: all 0.3s ease;
            border: 2px solid #4b5563;
            min-height: 80px;
        }
        .player-slot.active {
            border-color: #818cf8;
            transform: scale(1.05);
            box-shadow: 0 0 20px #818cf8;
        }
        .player-slot.correct {
            border-color: #22c55e;
            background-color: #166534;
            transform: scale(1.1);
            box-shadow: 0 0 25px #22c55e;
        }
        .player-slot.eliminated {
            opacity: 0.5;
            background-color: #374151;
            border-color: #1f2937;
            transform: scale(0.95);
        }
        @keyframes pulse-white-to-red {
            0% { color: #ffffff; }
            100% { color: #dc2626; transform: scale(1.1); }
        }
        .animate-pulse-white-to-red {
            animation: pulse-white-to-red 1s ease-out forwards;
        }
        .gold { background-image: linear-gradient(to right, #fde047, #eab308); color: #422006; border-color: #fde047 !important;}
        .silver { background-image: linear-gradient(to right, #e5e7eb, #a1a1aa); color: #1f2937; border-color: #e5e7eb !important;}
        .bronze { background-image: linear-gradient(to right, #b08d57, #9c7a4c); color: #fef3c7; border-color: #b08d57 !important;}
        
        .slot-container {
            height: 80px;
            overflow: hidden;
            position: relative;
            border-radius: 0.75rem;
            background-color: #1f2937;
            border: 2px solid #4b5563;
        }
        .slot-reel {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .slot-item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            background-color: #1f2937;
            backface-visibility: hidden;
            padding: 0 10px;
            font-size: 2.5rem;
            line-height: 1;
        }
        @keyframes modern-shine {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        .game-title {
            background: linear-gradient( 90deg, #a5b4fc, #6366f1, #a5b4fc );
            background-size: 200% auto;
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            animation: modern-shine 4s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div id="initial-screen" class="w-full max-w-sm">
        <div class="p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-black mb-6 text-indigo-400 text-center">YETI Kelime Oyunu</h1>
            <input id="nameInput" type="text" placeholder="ƒ∞sminizi Girin" maxlength="15" class="w-full p-3 mb-4 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="joinGameButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Oyuna Katƒ±l</button>
        </div>
    </div>

    <div id="game-container" class="hidden w-full max-w-6xl flex flex-col">
        <h1 class="game-title text-4xl md:text-6xl font-black text-center my-4">YETƒ∞ Kelime Oyunu</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 text-center p-8 bg-gray-800 rounded-2xl shadow-2xl flex flex-col justify-between">
                <div>
                     <div id="task-area" class="mb-6 p-4 bg-gray-900/50 rounded-xl">
                        <div class="grid grid-cols-2 gap-4">
                            <div id="letter-slot-container" class="slot-container">
                                <div class="slot-reel"></div>
                            </div>
                            <div id="category-slot-container" class="slot-container">
                                <div class="slot-reel"></div>
                            </div>
                        </div>
                    </div>
                     <div id="player-slots" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                </div>
                <div>
                    <div id="countdown" class="text-7xl md:text-8xl font-mono font-bold my-6 text-white h-24"></div>
                    <p id="status-text" class="text-lg text-gray-400 mb-6 h-8 flex items-center justify-center"></p>
                    <div id="game-buttons" class="h-14 flex items-center justify-center space-x-4">
                        <button id="startButton" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">
                            üé≤ Zar At & Ba≈ülat
                        </button>
                        <button id="newGameButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">
                            üéâ Yeni Oyun Ba≈ülat
                        </button>
                        <div id="host-decision-buttons" class="hidden space-x-4">
                             <button id="addWordYes" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">üëç Evet, Ekle</button>
                             <button id="addWordNo" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">üëé Hayƒ±r</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-800 rounded-2xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-1 text-center">üèÜ Puan Tablosu</h3>
                <div class="text-center bg-gray-900/50 py-2 px-4 rounded-lg mb-4">
                    Hedef: <span id="score-goal-display" class="font-bold text-xl text-yellow-300">10</span> Puan
                </div>
                <div id="host-options" class="hidden">
                     <label for="scoreGoalSelect" class="block mb-2 text-sm text-gray-300">Hedef Skoru Deƒüi≈ütir:</label>
                     <select id="scoreGoalSelect" class="w-full p-3 mb-4 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                         <option value="5">5 Puan</option>
                         <option value="10" selected>10 Puan</option>
                         <option value="15">15 Puan</option>
                         <option value="20">20 Puan</option>
                     </select>
                </div>
                <div id="scoreboard" class="space-y-2"></div>
                <button id="resetScoreButton" class="hidden w-full mt-6 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition">
                    Skorlarƒ± Sƒ±fƒ±rla
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `<div class="bg-red-900 border border-red-700 text-white p-8 rounded-lg shadow-xl max-w-lg mx-auto"><h1 class="text-3xl font-bold mb-4">Hata: Yanlƒ±≈ü √áalƒ±≈ütƒ±rma Y√∂ntemi</h1><p class="mb-2 text-lg">Bu dosyayƒ± doƒürudan √ßift tƒ±klayarak a√ßtƒ±nƒ±z. Bu oyunun √ßalƒ±≈ümasƒ± i√ßin bir sunucu √ºzerinden a√ßƒ±lmasƒ± gerekir.</p><p class="mt-4">L√ºtfen <strong>node server.js</strong> komutunu √ßalƒ±≈ütƒ±rdƒ±ktan sonra tarayƒ±cƒ±nƒ±zƒ±n adres √ßubuƒüuna ≈üunu yazƒ±n:</p><p class="text-2xl font-mono bg-gray-900 p-3 rounded my-4 text-center select-all">http://localhost:3000</p></div>`;
        } else {
            const initialScreen = document.getElementById('initial-screen');
            const gameContainer = document.getElementById('game-container');
            const nameInput = document.getElementById('nameInput');
            const joinGameButton = document.getElementById('joinGameButton');
            const statusText = document.getElementById('status-text');
            const playerSlotsDiv = document.getElementById('player-slots');
            const countdownEl = document.getElementById('countdown');
            const startButton = document.getElementById('startButton');
            const newGameButton = document.getElementById('newGameButton');
            const scoreboardDiv = document.getElementById('scoreboard');
            const resetScoreButton = document.getElementById('resetScoreButton');
            const scoreGoalSelect = document.getElementById('scoreGoalSelect');
            const scoreGoalDisplay = document.getElementById('score-goal-display');
            const hostOptions = document.getElementById('host-options');
            const letterSlotContainer = document.getElementById('letter-slot-container');
            const categorySlotContainer = document.getElementById('category-slot-container');
            const hostDecisionButtons = document.getElementById('host-decision-buttons');
            const addWordYesButton = document.getElementById('addWordYes');
            const addWordNoButton = document.getElementById('addWordNo');

            let synth = null;
            let myDetails = null;
            let currentHostId = null;
            let wordToAddInfo = null;
            const socket = io("http://192.168.1.102:3000");
            const alphabet = 'ABC√áDEFHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ'.split('');
            const categories = ['ƒ∞sim', 'Hayvan', 'Bitki/Meyve/Sebze', '√úlke/≈ûehir/ƒ∞l√ße', 'E≈üya', 'Meslek'];
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.continuous = false;
            }

            function populateReel(reelContainer, items, clones = 5) {
                const reel = reelContainer.querySelector('.slot-reel');
                reel.innerHTML = '';
                const itemContainer = document.createElement('div');
                for (let i = 0; i < clones; i++) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `slot-item`;
                        div.textContent = item;
                        itemContainer.appendChild(div);
                    });
                }
                reel.appendChild(itemContainer);
            }
            populateReel(letterSlotContainer, alphabet);
            populateReel(categorySlotContainer, categories);
            
            function spinReel(reelContainer, items, finalIndex) {
                const reel = reelContainer.querySelector('.slot-reel');
                const itemHeight = 80;
                const singleSetHeight = items.length * itemHeight;

                reel.style.transition = 'none';
                reel.style.top = `0px`;
                reel.offsetHeight;

                const spinCount = 4;
                const finalPosition = (spinCount * singleSetHeight) + (finalIndex * itemHeight);
                
                reel.style.transition = 'top 2.5s cubic-bezier(0.25, 1, 0.5, 1)';
                reel.style.top = `-${finalPosition}px`;
                
                setTimeout(() => {
                    reel.style.transition = 'none';
                    const resetPosition = finalIndex * itemHeight;
                    reel.style.top = `-${resetPosition}px`;
                }, 2550);
            }

            function updatePlayerSlots(players = []) {
                playerSlotsDiv.innerHTML = '';
                for (let i = 1; i <= 8; i++) {
                    const player = players.find(p => p.playerNumber === i);
                    const slot = document.createElement('div');
                    slot.className = 'player-slot p-4 rounded-lg flex flex-col justify-center items-center';
                    if (player) {
                        slot.id = `player-slot-${player.id}`;
                        slot.innerHTML = `<div class="font-bold text-xl">${player.name}</div><div class="text-sm text-gray-400">Oyuncu ${i}</div>`;
                    } else {
                        slot.innerHTML = `<div class="text-gray-500">Bo≈ü Slot</div>`;
                    }
                    playerSlotsDiv.appendChild(slot);
                }
            }
            
            function updateScoreboard(scores = {}, isGameOver = false) {
                scoreboardDiv.innerHTML = '';
                const sortedScores = Object.entries(scores).sort(([,a],[,b]) => b-a);
                if (sortedScores.length === 0) {
                    scoreboardDiv.innerHTML = '<p class="text-gray-500 text-center">Hen√ºz puan yok.</p>';
                } else {
                    sortedScores.forEach(([name, score], index) => {
                        const rank = index + 1;
                        let rankClass = '';
                        if (isGameOver) {
                            if (rank === 1) rankClass = 'gold';
                            else if (rank === 2) rankClass = 'silver';
                            else if (rank === 3) rankClass = 'bronze';
                        }
                        const scoreEntry = document.createElement('div');
                        scoreEntry.className = `flex justify-between items-center p-2 rounded-md border-2 border-transparent bg-gray-700 ${rankClass}`;
                        scoreEntry.innerHTML = `<div class="flex items-center"><span class="font-bold mr-3 text-lg w-6 text-center">${rank}.</span><span class="font-semibold">${name}</span></div><span class="font-bold text-xl">${score}</span>`;
                        scoreboardDiv.appendChild(scoreEntry);
                    });
                }
            }

            function initializeAudio() {
                if(synth) return;
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                synth = new Tone.Synth().toDestination();
            }
            
            joinGameButton.addEventListener('click', () => {
                const name = nameInput.value.trim();
                if (!name) return alert('L√ºtfen bir isim girin.');
                initializeAudio();
                socket.emit('joinGame', { name });
            });
            
            scoreGoalSelect.addEventListener('change', () => {
                if (myDetails && myDetails.id === currentHostId) {
                    socket.emit('scoreGoalChanged', parseInt(scoreGoalSelect.value, 10));
                }
            });
            
            startButton.addEventListener('click', () => socket.emit('startDiceRoll'));
            newGameButton.addEventListener('click', () => socket.emit('newGame'));
            resetScoreButton.addEventListener('click', () => {
                if (confirm('T√ºm skorlarƒ± sƒ±fƒ±rlamak istediƒüinizden emin misiniz?')) {
                    socket.emit('resetScores');
                }
            });

            addWordYesButton.addEventListener('click', () => {
                if(wordToAddInfo) {
                    socket.emit('hostDecisionOnWord', { add: true, wordInfo: wordToAddInfo });
                    hostDecisionButtons.classList.add('hidden');
                }
            });
            addWordNoButton.addEventListener('click', () => {
                 if(wordToAddInfo) {
                    socket.emit('hostDecisionOnWord', { add: false, wordInfo: wordToAddInfo });
                    hostDecisionButtons.classList.add('hidden');
                }
            });

            recognition.onresult = (event) => socket.emit('wordSpoken', event.results[0][0].transcript);
            recognition.onerror = (event) => console.error('Ses tanƒ±ma hatasƒ±:', event.error);

            socket.on('joined', ({ playerDetails }) => {
                myDetails = playerDetails;
                initialScreen.classList.add('hidden');
                gameContainer.classList.remove('hidden');
            });

            socket.on('lobbyUpdate', ({ players, gameHostId, scoreGoal }) => {
                currentHostId = gameHostId;
                updatePlayerSlots(players);
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('eliminated', 'active', 'correct'));
                statusText.textContent = `${players.length} / 8 oyuncu bekleniyor...`;
                countdownEl.textContent = '';
                scoreGoalDisplay.textContent = scoreGoal;
                scoreGoalSelect.value = scoreGoal;
                
                const isHost = myDetails && myDetails.id === gameHostId;
                hostOptions.classList.toggle('hidden', !isHost);
                startButton.classList.toggle('hidden', !(isHost && players.length >= 1)); // 2'den 1'e d√º≈ü√ºr√ºld√º test i√ßin.
                newGameButton.classList.add('hidden');
                hostDecisionButtons.classList.add('hidden');
                resetScoreButton.classList.toggle('hidden', !isHost);
            });

            socket.on('scoreUpdate', ({ scores, isGameOver }) => updateScoreboard(scores, isGameOver));

            socket.on('diceRolling', ({ finalLetterIndex, finalCategoryIndex, letter, category }) => {
                startButton.classList.add('hidden');
                newGameButton.classList.add('hidden');
                statusText.textContent = 'Zar atƒ±lƒ±yor...';
                populateReel(letterSlotContainer, alphabet);
                populateReel(categorySlotContainer, categories);
                spinReel(letterSlotContainer, alphabet, finalLetterIndex);
                spinReel(categorySlotContainer, categories, finalCategoryIndex);
            });

            socket.on('gameStart', () => {
                statusText.textContent = '';
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('eliminated'));
            });

            socket.on('playerEliminated', ({ loserId, loserName, reason, word }) => {
                 if (synth) synth.triggerAttackRelease("C3", "8n");
                 const playerSlot = document.querySelector(`#player-slot-${loserId}`);
                 if(playerSlot) {
                    playerSlot.classList.add('eliminated');
                 }
                 let statusMessage = `${loserName}, "${reason}" nedeniyle elendi.`;
                 if (word) {
                    statusMessage += ` (S√∂ylenen: "${word}")`;
                 }
                 statusText.textContent = statusMessage;
            });

            socket.on('askHostAboutWord', (wordInfo) => {
                wordToAddInfo = wordInfo;
                statusText.textContent = `'${wordInfo.word}' kelimesi DB'ye eklensin mi?`;
                hostDecisionButtons.classList.remove('hidden');
                countdownEl.textContent = '';
            });

            socket.on('turnUpdate', ({ player, timeLeft, activePlayersCount }) => {
                hostDecisionButtons.classList.add('hidden');
                if (activePlayersCount >= 3 && synth) {
                     synth.triggerAttackRelease("G4", "16n");
                }
                
                statusText.textContent = '';
                countdownEl.textContent = timeLeft;
                countdownEl.classList.remove('animate-pulse-white-to-red');
                
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('active'));
                const activeSlot = document.querySelector(`#player-slot-${player.id}`);
                if(activeSlot) activeSlot.classList.add('active');

                if (myDetails && myDetails.id === player.id) {
                    try { 
                        recognition.start(); 
                    } catch(e) { 
                        console.error("Ses tanƒ±ma ba≈ülatƒ±lamadƒ±!", e);
                        statusText.textContent = "Mikrofon kullanƒ±lamƒ±yor!";
                    }
                }
            });
            
            socket.on('countdown', (timeLeft) => {
                countdownEl.textContent = timeLeft >= 0 ? timeLeft : 0;
                if (timeLeft === 0) {
                    countdownEl.classList.add('animate-pulse-white-to-red');
                }
            });

            socket.on('wordAccepted', ({ playerNumber, word }) => {
                if (synth) synth.triggerAttackRelease("C5", "8n");
                const correctSlot = document.querySelector(`.player-slot:nth-child(${playerNumber})`);
                if (correctSlot) {
                    correctSlot.classList.add('correct');
                    setTimeout(() => correctSlot.classList.remove('correct'), 600);
                }
            });

            socket.on('roundOver', ({ reason, winner }) => {
                hostDecisionButtons.classList.add('hidden');
                if (winner && synth) {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C5", "16n", now);
                    synth.triggerAttackRelease("E5", "16n", now + 0.1);
                    synth.triggerAttackRelease("G5", "8n", now + 0.2);
                } else if (synth) {
                    synth.triggerAttackRelease("E3", "8n");
                }
                if (recognition) recognition.stop();
                statusText.textContent = winner ? `${reason} | Turun galibi: ${winner}` : reason;
                countdownEl.textContent = '';
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('active', 'eliminated'));
                const isHost = myDetails && myDetails.id === currentHostId;
                startButton.classList.toggle('hidden', !isHost);
            });

            socket.on('finalWinner', ({winner, scores}) => {
                if (recognition) recognition.stop();
                updateScoreboard(scores, true);
                countdownEl.textContent = '';
                statusText.innerHTML = `<div class="text-3xl">üèÜ Oyun Bitti! Kazanan: <span class="gold font-black">${winner}</span> üèÜ</div>`;
                const isHost = myDetails && myDetails.id === currentHostId;
                newGameButton.classList.toggle('hidden', !isHost);
                startButton.classList.add('hidden');
                hostDecisionButtons.classList.add('hidden');
            });
            
            socket.on('gameError', (message) => alert(message));
            socket.on('dbUpdateSuccess', (message) => {
                const originalText = statusText.textContent;
                statusText.textContent = message;
                setTimeout(() => statusText.textContent = 'Oyun devam ediyor...', 2000);
            });
            socket.on('dbUpdateError', (message) => alert(message));
        }
    </script>
</body>
</html>

