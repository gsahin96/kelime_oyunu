<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YETI Kelime Oyunu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        .hidden { display: none; }
        .player-slot { 
            transition: all 0.3s ease;
            border: 2px solid #4b5563;
            min-height: 80px;
        }
        .player-slot.active {
            border-color: #818cf8;
            transform: scale(1.05);
            box-shadow: 0 0 20px #818cf8;
        }
        .player-slot.correct {
            border-color: #22c55e;
            background-color: #166534;
            transform: scale(1.1);
            box-shadow: 0 0 25px #22c55e;
        }
        .player-slot.eliminated {
            opacity: 0.5;
            background-color: #374151;
            border-color: #1f2937;
            transform: scale(0.95);
        }
        @keyframes pulse-white-to-red {
            0% { color: #ffffff; }
            100% { color: #dc2626; transform: scale(1.1); }
        }
        .animate-pulse-white-to-red {
            animation: pulse-white-to-red 1s ease-out forwards;
        }
        .gold { background-image: linear-gradient(to right, #fde047, #eab308); color: #422006; border-color: #fde047 !important;}
        .silver { background-image: linear-gradient(to right, #e5e7eb, #a1a1aa); color: #1f2937; border-color: #e5e7eb !important;}
        .bronze { background-image: linear-gradient(to right, #b08d57, #9c7a4c); color: #fef3c7; border-color: #b08d57 !important;}
        
        .slot-container {
            height: 80px;
            overflow: hidden;
            position: relative;
            border-radius: 0.75rem;
            background-color: #1f2937;
            border: 2px solid #4b5563;
        }
        .slot-reel {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            transition: top 2.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .slot-item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            background-color: #1f2937;
            backface-visibility: hidden;
            padding: 0 10px;
            font-size: 2.5rem;
            line-height: 1;
        }
        @keyframes modern-shine {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        .game-title {
            background: linear-gradient( 90deg, #a5b4fc, #6366f1, #a5b4fc );
            background-size: 200% auto;
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            animation: modern-shine 4s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div id="initial-screen" class="w-full max-w-sm">
        <div class="p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-black mb-6 text-indigo-400 text-center">YETI Kelime Oyunu</h1>
            <input id="nameInput" type="text" placeholder="ƒ∞sminizi Girin" maxlength="15" class="w-full p-3 mb-4 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div id="join-options">
                <button id="createRoomButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition mb-2">Oda Olu≈ütur</button>
                <button id="showJoinFormButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition mb-2">Odaya Katƒ±l</button>
                <button id="showStatsButton" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition mb-2">üìä ƒ∞statistiklerim</button>
                <div class="my-4 border-t border-gray-700"></div>
                <button id="startSinglePlayerButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Tek Ba≈üƒ±na Oyna</button>
            </div>

            <div id="join-form" class="hidden">
                <input id="roomInput" type="text" placeholder="Oda Kodunu Gir" maxlength="6" class="w-full p-3 mb-4 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 uppercase">
                <button id="joinRoomButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition">Katƒ±l</button>
                <button id="backToOptionsButton" class="w-full mt-2 text-gray-400 hover:text-white transition">Geri</button>
            </div>
        </div>
    </div>

    <!-- Player Statistics Screen -->
    <div id="stats-screen" class="hidden w-full max-w-4xl">
        <div class="p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-yellow-400">üìä Oyuncu ƒ∞statistikleri</h2>
            
            <div id="stats-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Game Statistics -->
                <div class="bg-gray-900/50 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-4 text-indigo-400">üéÆ Oyun ƒ∞statistikleri</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Oynanan Oyun:</span>
                            <span class="font-bold text-white" id="stat-games-played">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Kazanƒ±lan Oyun:</span>
                            <span class="font-bold text-green-400" id="stat-games-won">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Kazanma Oranƒ±:</span>
                            <span class="font-bold text-yellow-400" id="stat-win-rate">0%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">En Uzun Galibiyet Serisi:</span>
                            <span class="font-bold text-purple-400" id="stat-longest-streak">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Mevcut Seri:</span>
                            <span class="font-bold text-blue-400" id="stat-current-streak">0</span>
                        </div>
                    </div>
                </div>

                <!-- Word Statistics -->
                <div class="bg-gray-900/50 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-4 text-green-400">üìù Kelime ƒ∞statistikleri</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Toplam Doƒüru Kelime:</span>
                            <span class="font-bold text-white" id="stat-total-words">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Ortalama Cevap S√ºresi:</span>
                            <span class="font-bold text-cyan-400" id="stat-avg-time">0s</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">En Sevilen Kategori:</span>
                            <span class="font-bold text-pink-400" id="stat-fav-category">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Son Oyun:</span>
                            <span class="font-bold text-gray-400" id="stat-last-played">-</span>
                        </div>
                    </div>
                </div>

                <!-- Most Used Words -->
                <div class="bg-gray-900/50 p-6 rounded-lg md:col-span-2">
                    <h3 class="text-xl font-bold mb-4 text-orange-400">üî§ En √áok Kullanƒ±lan Kelimeler</h3>
                    <div id="most-used-words" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <p class="text-gray-500 col-span-full text-center">Hen√ºz kelime verisi yok</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button id="closeStatsButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">
                    Geri D√∂n
                </button>
            </div>
        </div>
    </div>

    <div id="lobby-screen" class="hidden w-full max-w-lg text-center">
        <h2 class="text-3xl font-bold text-indigo-400 mb-4">Oyun Lobisi</h2>
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
            <p class="text-gray-400 mb-2">Arkada≈ülarƒ±nƒ± davet et:</p>
            <div class="flex items-center justify-center space-x-2">
                <input id="roomLinkInput" type="text" readonly class="w-full p-3 bg-gray-700 rounded-lg text-white text-center font-mono select-all">
                <button id="copyLinkButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-lg transition">Kopyala</button>
            </div>
        </div>
    </div>


    <div id="game-container" class="hidden w-full max-w-6xl flex-col">
        <div id="invite-link-ingame" class="w-full max-w-md mx-auto mb-4 text-center"></div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 text-center p-8 bg-gray-800 rounded-2xl shadow-2xl flex flex-col justify-between">
                <div>
                     <div id="task-area" class="mb-6 p-4 bg-gray-900/50 rounded-xl">
                        <div class="grid grid-cols-2 gap-4">
                            <div id="letter-slot-container" class="slot-container">
                                <div class="slot-reel"><div class="slot-item"></div></div>
                            </div>
                            <div id="category-slot-container" class="slot-container">
                                <div class="slot-reel"><div class="slot-item"></div></div>
                            </div>
                        </div>
                    </div>
                     <div id="player-slots" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                </div>
                <div>
                    <div id="countdown" class="text-7xl md:text-8xl font-mono font-bold my-6 text-white h-24"></div>
                    <p id="status-text" class="text-lg text-gray-400 mb-6 h-8 flex items-center justify-center"></p>
                    <div id="game-buttons" class="h-14 flex items-center justify-center space-x-4">
                        <button id="startButton" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">
                            üé≤ Zar At & Ba≈ülat
                        </button>
                        <button id="newGameButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">
                            üéâ Yeni Oyun Ba≈ülat
                        </button>
                        <div id="host-decision-buttons" class="hidden space-x-4">
                             <button id="addWordYes" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">üëç Evet, Ekle</button>
                             <button id="addWordNo" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">üëé Hayƒ±r</button>
                        </div>
                    </div>
                     <div id="word-input-area" class="hidden mt-4">
                        <form id="word-form" class="flex justify-center space-x-2">
                            <input type="text" id="wordInput" placeholder="Kelimeyi buraya yazƒ±n..." class="w-full max-w-xs p-3 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button type="submit" id="sendWordButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition">G√∂nder</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="sidebar" class="p-6 bg-gray-800 rounded-2xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-1 text-center">üèÜ Puan Tablosu & Ayarlar</h3>
                <div class="text-center bg-gray-900/50 py-2 px-4 rounded-lg mb-4 grid grid-cols-2 gap-4">
                    <div>Hedef: <span id="score-goal-display" class="font-bold text-xl text-yellow-300">10</span></div>
                    <div>S√ºre: <span id="turn-duration-display" class="font-bold text-xl text-yellow-300">5</span>sn</div>
                </div>
                <div id="host-options" class="hidden space-y-4">
                     <div>
                        <label for="scoreGoalSelect" class="block mb-2 text-sm text-gray-300">Hedef Skoru Deƒüi≈ütir:</label>
                        <select id="scoreGoalSelect" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="5">5 Puan</option>
                            <option value="10" selected>10 Puan</option>
                            <option value="15">15 Puan</option>
                            <option value="20">20 Puan</option>
                        </select>
                     </div>
                     <div>
                        <label for="turnDurationSelect" class="block mb-2 text-sm text-gray-300">Tur S√ºresini Deƒüi≈ütir:</label>
                        <select id="turnDurationSelect" class="w-full p-3 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="5" selected>5 Saniye</option>
                            <option value="10">10 Saniye</option>
                            <option value="15">15 Saniye</option>
                        </select>
                     </div>
                </div>
                <div id="scoreboard" class="space-y-2 mt-4"></div>
                
                <!-- Used Words Section -->
                <div id="used-words-section" class="mt-6">
                    <h4 class="text-lg font-bold mb-2 text-center text-green-400">‚úÖ Kullanƒ±lan Kelimeler</h4>
                    <div id="used-words-list" class="bg-gray-900/50 rounded-lg p-3 max-h-40 overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center" id="no-words-text">Hen√ºz kelime girilmedi</p>
                    </div>
                </div>
                
                <button id="resetScoreButton" class="hidden w-full mt-6 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition">
                    Skorlarƒ± Sƒ±fƒ±rla
                </button>
            </div>
        </div>
    </div>

    <!-- Tek Oyunculu Mod Aray√ºz√º -->
    <div id="single-player-container" class="hidden w-full max-w-2xl flex flex-col text-center">
        <h1 class="game-title text-4xl md:text-6xl font-black text-center my-4">Tek Ba≈üƒ±na Oyna</h1>
        <div class="p-8 bg-gray-800 rounded-2xl shadow-2xl">
             <div id="sp-task-area" class="mb-6 p-4 bg-gray-900/50 rounded-xl">
                 <div class="text-3xl"><span id="sp-letter" class="font-bold text-indigo-300">A</span> harfi ile ba≈ülayan <span id="sp-category" class="font-bold text-indigo-300">ƒ∞sim</span></div>
            </div>
            <div id="sp-score" class="text-5xl font-bold mb-4">Puan: <span class="text-yellow-300">0</span></div>
            <div id="sp-countdown" class="text-8xl font-mono font-bold my-6 text-white h-28"></div>
            <p id="sp-status-text" class="text-lg text-gray-400 mb-6 h-8"></p>
            <div id="sp-word-input-area" class="mt-4">
                <form id="sp-word-form" class="flex justify-center space-x-2">
                    <input type="text" id="sp-wordInput" placeholder="Kelimeyi buraya yazƒ±n..." class="w-full max-w-xs p-3 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition">G√∂nder</button>
                </form>
            </div>

            <div id="sp-game-over" class="hidden">
                 <h2 class="text-4xl font-bold text-red-500 mb-4">Oyun Bitti!</h2>
                 <p class="text-2xl mb-6">Toplam Puanƒ±n: <span id="sp-final-score" class="font-bold text-yellow-300">0</span></p>
                 <button id="sp-replay-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl mr-2">Yeniden Oyna</button>
                 <button id="sp-main-menu-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition text-xl">Ana Men√º</button>
            </div>
            
            <!-- Single Player Used Words Section -->
            <div id="sp-used-words-section" class="mt-6">
                <h4 class="text-lg font-bold mb-2 text-center text-green-400">‚úÖ Kullanƒ±lan Kelimeler</h4>
                <div id="sp-used-words-list" class="bg-gray-900/50 rounded-lg p-3 max-h-40 overflow-y-auto">
                    <p class="text-gray-500 text-sm text-center" id="sp-no-words-text">Hen√ºz kelime girilmedi</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `<div class="bg-red-900 border border-red-700 text-white p-8 rounded-lg shadow-xl max-w-lg mx-auto"><h1 class="text-3xl font-bold mb-4">Hata: Yanlƒ±≈ü √áalƒ±≈ütƒ±rma Y√∂ntemi</h1><p class="mb-2 text-lg">Bu dosyayƒ± doƒürudan √ßift tƒ±klayarak a√ßtƒ±nƒ±z. Bu oyunun √ßalƒ±≈ümasƒ± i√ßin bir sunucu √ºzerinden a√ßƒ±lmasƒ± gerekir.</p><p class="mt-4">L√ºtfen <strong>node server.js</strong> komutunu √ßalƒ±≈ütƒ±rdƒ±ktan sonra tarayƒ±cƒ±nƒ±zƒ±n adres √ßubuƒüuna ≈üunu yazƒ±n:</p><p class="text-2xl font-mono bg-gray-900 p-3 rounded my-4 text-center select-all">http://localhost:3000</p></div>`;
        } else {
            // Element Tanƒ±mlamalarƒ±
            const initialScreen = document.getElementById('initial-screen');
            const gameContainer = document.getElementById('game-container');
            const singlePlayerContainer = document.getElementById('single-player-container');
            const nameInput = document.getElementById('nameInput');
            const createRoomButton = document.getElementById('createRoomButton');
            const showJoinFormButton = document.getElementById('showJoinFormButton');
            const showStatsButton = document.getElementById('showStatsButton');
            const joinOptions = document.getElementById('join-options');
            const joinForm = document.getElementById('join-form');
            const roomInput = document.getElementById('roomInput');
            const joinRoomButton = document.getElementById('joinRoomButton');
            const backToOptionsButton = document.getElementById('backToOptionsButton');
            const startSinglePlayerButton = document.getElementById('startSinglePlayerButton');
            const lobbyScreen = document.getElementById('lobby-screen');
            const roomLinkInput = document.getElementById('roomLinkInput');
            const copyLinkButton = document.getElementById('copyLinkButton');
            const inviteLinkInGame = document.getElementById('invite-link-ingame');
            const statusText = document.getElementById('status-text');
            const playerSlotsDiv = document.getElementById('player-slots');
            const countdownEl = document.getElementById('countdown');
            const startButton = document.getElementById('startButton');
            const newGameButton = document.getElementById('newGameButton');
            const scoreboardDiv = document.getElementById('scoreboard');
            const resetScoreButton = document.getElementById('resetScoreButton');
            const scoreGoalSelect = document.getElementById('scoreGoalSelect');
            const scoreGoalDisplay = document.getElementById('score-goal-display');
            const hostOptions = document.getElementById('host-options');
            const letterSlotContainer = document.getElementById('letter-slot-container');
            const categorySlotContainer = document.getElementById('category-slot-container');
            const hostDecisionButtons = document.getElementById('host-decision-buttons');
            const addWordYesButton = document.getElementById('addWordYes');
            const addWordNoButton = document.getElementById('addWordNo');
            const wordInputArea = document.getElementById('word-input-area');
            const wordInput = document.getElementById('wordInput');
            const wordForm = document.getElementById('word-form');
            const turnDurationSelect = document.getElementById('turnDurationSelect');
            const turnDurationDisplay = document.getElementById('turn-duration-display');
            const spTaskArea = document.getElementById('sp-task-area');
            const spScoreEl = document.getElementById('sp-score').querySelector('span');
            const spCountdownEl = document.getElementById('sp-countdown');
            const spStatusText = document.getElementById('sp-status-text');
            const spWordInputArea = document.getElementById('sp-word-input-area');
            const spWordForm = document.getElementById('sp-word-form');
            const spWordInput = document.getElementById('sp-wordInput');
            const spGameOverScreen = document.getElementById('sp-game-over');
            const spFinalScoreEl = document.getElementById('sp-final-score');
            const spReplayButton = document.getElementById('sp-replay-button');
            const spMainMenuButton = document.getElementById('sp-main-menu-button');
            const spLetterEl = document.getElementById('sp-letter');
            const spCategoryEl = document.getElementById('sp-category');
            
            // Used Words Elements
            const usedWordsList = document.getElementById('used-words-list');
            const noWordsText = document.getElementById('no-words-text');
            const spUsedWordsList = document.getElementById('sp-used-words-list');
            const spNoWordsText = document.getElementById('sp-no-words-text');
            
            // Statistics Elements
            const statsScreen = document.getElementById('stats-screen');
            const closeStatsButton = document.getElementById('closeStatsButton');

            let synth = null;
            let myDetails = null;
            let currentHostId = null;
            let currentRoomId = null;
            let wordToAddInfo = null;
            const socket = io();
            const alphabet = 'ABC√áDEFHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ'.split('');
            const categories = ['ƒ∞sim', 'Hayvan', 'Bitki/Meyve/Sebze', '√úlke/≈ûehir/ƒ∞l√ße', 'E≈üya', 'Meslek'];
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'tr-TR';
                recognition.continuous = false;
            }
            
            showJoinFormButton.addEventListener('click', () => {
                joinOptions.classList.add('hidden');
                joinForm.classList.remove('hidden');
            });
            backToOptionsButton.addEventListener('click', () => {
                joinForm.classList.add('hidden');
                joinOptions.classList.remove('hidden');
            });
             const validateInputs = () => {
                const name = nameInput.value.trim();
                if (!name) {
                    alert('L√ºtfen bir isim girin.');
                    return false;
                }
                return { name };
            };
            createRoomButton.addEventListener('click', () => {
                const { name } = validateInputs();
                if (name) {
                    initializeAudio();
                    socket.emit('createRoom', { name });
                }
            });
            joinRoomButton.addEventListener('click', () => {
                const { name } = validateInputs();
                const roomId = roomInput.value.trim().toUpperCase();
                if (!roomId) {
                    alert('L√ºtfen bir oda kodu girin.');
                    return;
                }
                if (name) {
                    initializeAudio();
                    socket.emit('joinRoom', { name, roomId });
                }
            });

            startSinglePlayerButton.addEventListener('click', () => {
                const { name } = validateInputs();
                if(name) {
                    initializeAudio();
                    socket.emit('startSinglePlayer', { name });
                }
            });

            spReplayButton.addEventListener('click', () => {
                const { name } = validateInputs();
                if (name) socket.emit('startSinglePlayer', { name });
            });
            spMainMenuButton.addEventListener('click', () => window.location.reload());
            
            copyLinkButton.addEventListener('click', () => {
                roomLinkInput.select();
                document.execCommand('copy');
                copyLinkButton.textContent = 'Kopyalandƒ±!';
                setTimeout(() => { copyLinkButton.textContent = 'Kopyala'; }, 1500);
            });
             startButton.addEventListener('click', () => socket.emit('startDiceRoll'));
             newGameButton.addEventListener('click', () => socket.emit('newGame'));
             resetScoreButton.addEventListener('click', () => {
                 if (confirm('T√ºm skorlarƒ± sƒ±fƒ±rlamak istediƒüinizden emin misiniz?')) {
                     socket.emit('resetScores');
                 }
             });
             function sendSettingsUpdate() {
                 if (myDetails && myDetails.id === currentHostId) {
                    socket.emit('gameSettingsChanged', { 
                        scoreGoal: parseInt(scoreGoalSelect.value, 10),
                        turnDuration: parseInt(turnDurationSelect.value, 10)
                    });
                }
             }
             scoreGoalSelect.addEventListener('change', sendSettingsUpdate);
             turnDurationSelect.addEventListener('change', sendSettingsUpdate);
             addWordYesButton.addEventListener('click', () => {
                if(wordToAddInfo) {
                    socket.emit('hostDecisionOnWord', { add: true, wordInfo: wordToAddInfo });
                    hostDecisionButtons.classList.add('hidden');
                }
             });
             addWordNoButton.addEventListener('click', () => {
                 if(wordToAddInfo) {
                    socket.emit('hostDecisionOnWord', { add: false, wordInfo: wordToAddInfo });
                    hostDecisionButtons.classList.add('hidden');
                }
             });

            window.addEventListener('load', () => {
                const params = new URLSearchParams(window.location.search);
                const roomIdFromUrl = params.get('oda');
                if (roomIdFromUrl) {
                    roomInput.value = roomIdFromUrl.toUpperCase();
                    showJoinFormButton.click();
                }
            });
            
            function submitWord(word) {
                if (word && word.trim()) {
                    socket.emit('submitWord', word.trim());
                    wordInput.value = '';
                    wordInputArea.classList.add('hidden');
                    if (recognition) recognition.stop();
                }
            }

            wordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                submitWord(wordInput.value);
            });
            
            spWordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                submitWord(spWordInput.value);
                spWordInput.value = '';
            });

            if(recognition) {
                recognition.onresult = (event) => submitWord(event.results[0][0].transcript);
                recognition.onerror = (event) => console.error('Ses tanƒ±ma hatasƒ±:', event.error);
            }
            
            socket.on('roomCreated', ({ roomId, playerDetails }) => {
                myDetails = playerDetails;
                currentRoomId = roomId;
                initialScreen.classList.add('hidden');
                lobbyScreen.classList.remove('hidden');
                gameContainer.classList.remove('hidden');
                
                const link = `${window.location.origin}?oda=${roomId}`;
                roomLinkInput.value = link;
                inviteLinkInGame.innerHTML = lobbyScreen.innerHTML;
                lobbyScreen.classList.add('hidden');
            });
            socket.on('joined', ({ playerDetails, roomId }) => {
                myDetails = playerDetails;
                currentRoomId = roomId;
                initialScreen.classList.add('hidden');
                lobbyScreen.classList.add('hidden');
                gameContainer.classList.remove('hidden');
            });
            socket.on('lobbyUpdate', ({ players, gameHostId, settings }) => {
                currentHostId = gameHostId;
                updatePlayerSlots(players);
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('eliminated', 'active', 'correct'));
                statusText.textContent = `${players.length} / 8 oyuncu bekleniyor...`;
                countdownEl.textContent = '';
                updateUsedWords([], false); // Clear used words when returning to lobby
                
                scoreGoalDisplay.textContent = settings.scoreGoal;
                scoreGoalSelect.value = settings.scoreGoal;
                turnDurationDisplay.textContent = settings.turnDuration;
                turnDurationSelect.value = settings.turnDuration;

                const isHost = myDetails && myDetails.id === gameHostId;
                
                const linkDiv = document.querySelector('#invite-link-ingame');
                if(linkDiv) linkDiv.classList.toggle('hidden', !isHost || players.length === 8);
                if (isHost) {
                    const linkInput = document.querySelector('#invite-link-ingame input');
                    const copyButton = document.querySelector('#invite-link-ingame button');
                    if(linkInput) linkInput.value = `${window.location.origin}?oda=${currentRoomId}`;
                    if(copyButton) copyButton.onclick = () => {
                        linkInput.select();
                        document.execCommand('copy');
                        copyButton.textContent = 'Kopyalandƒ±!';
                        setTimeout(() => { copyButton.textContent = 'Kopyala'; }, 1500);
                    };
                }

                hostOptions.classList.toggle('hidden', !isHost);
                startButton.classList.toggle('hidden', !(isHost && players.length >= 1));
                newGameButton.classList.add('hidden');
                hostDecisionButtons.classList.add('hidden');
                resetScoreButton.classList.toggle('hidden', !isHost);
            });

            function updateTaskDisplay(letter, category) {
                const letterReel = letterSlotContainer.querySelector('.slot-reel');
                const categoryReel = categorySlotContainer.querySelector('.slot-reel');
                letterReel.style.transition = 'none';
                categoryReel.style.transition = 'none';

                const letterIndex = alphabet.indexOf(letter);
                if (letterIndex > -1) {
                    letterReel.style.top = `-${letterIndex * 80}px`;
                }

                const categoryIndex = categories.indexOf(category);
                if (categoryIndex > -1) {
                    categoryReel.style.top = `-${categoryIndex * 80}px`;
                }
            }
            
            socket.on('scoreUpdate', ({ scores, isGameOver }) => updateScoreboard(scores, isGameOver));
            socket.on('usedWordsUpdate', ({ usedWords }) => {
                updateUsedWords(usedWords, false);
                updateUsedWords(usedWords, true); // Update both displays
            });
            socket.on('diceRolling', ({ finalLetterIndex, finalCategoryIndex, letter, category }) => {
                startButton.classList.add('hidden');
                newGameButton.classList.add('hidden');
                statusText.textContent = 'Zar atƒ±lƒ±yor...';
                populateReel(letterSlotContainer, alphabet);
                populateReel(categorySlotContainer, categories);
                spinReel(letterSlotContainer, alphabet, finalLetterIndex);
                spinReel(categorySlotContainer, categories, finalCategoryIndex);
            });
            socket.on('gameStart', () => {
                statusText.textContent = '';
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('eliminated'));
                updateUsedWords([], false); // Initialize empty used words for multiplayer
            });
            socket.on('playerEliminated', ({ loserId, loserName, reason, word }) => {
                 if (synth) synth.triggerAttackRelease("C3", "8n");
                 const playerSlot = document.querySelector(`#player-slot-${loserId}`);
                 if(playerSlot) {
                    playerSlot.classList.add('eliminated');
                 }
                 let statusMessage = `${loserName}, "${reason}" nedeniyle elendi.`;
                 if (word) {
                    statusMessage += ` (S√∂ylenen: "${word}")`;
                 }
                 statusText.textContent = statusMessage;
                 if (myDetails && myDetails.id === loserId) {
                    wordInputArea.classList.add('hidden');
                 }
            });
            socket.on('askHostAboutWord', (wordInfo) => {
                wordToAddInfo = wordInfo;
                statusText.textContent = `'${wordInfo.word}' kelimesi DB'ye eklensin mi?`;
                hostDecisionButtons.classList.remove('hidden');
                countdownEl.textContent = '';
            });
            socket.on('turnUpdate', ({ player, timeLeft, activePlayersCount, letter, category }) => {
                updateTaskDisplay(letter, category);
                hostDecisionButtons.classList.add('hidden');
                if (activePlayersCount >= 3 && synth) {
                     synth.triggerAttackRelease("G4", "16n");
                }
                
                statusText.textContent = '';
                countdownEl.textContent = timeLeft;
                countdownEl.classList.remove('animate-pulse-white-to-red');
                
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('active'));
                const activeSlot = document.querySelector(`#player-slot-${player.id}`);
                if(activeSlot) activeSlot.classList.add('active');

                const isMyTurn = myDetails && myDetails.id === player.id;
                wordInputArea.classList.toggle('hidden', !isMyTurn);

                if (isMyTurn) {
                    wordInput.focus();
                    if (recognition) {
                        try { 
                            recognition.start(); 
                        } catch(e) { 
                            console.error("Ses tanƒ±ma ba≈ülatƒ±lamadƒ±!", e);
                            statusText.textContent = "Mikrofon kullanƒ±lamƒ±yor, yazarak cevap verin.";
                        }
                    }
                } else {
                     if (recognition) recognition.stop();
                }
            });
            socket.on('countdown', (timeLeft) => {
                countdownEl.textContent = timeLeft >= 0 ? timeLeft : 0;
                if (timeLeft === 0) {
                    countdownEl.classList.add('animate-pulse-white-to-red');
                }
            });
            socket.on('wordAccepted', ({ playerNumber, word }) => {
                if (synth) synth.triggerAttackRelease("C5", "8n");
                const correctSlot = document.querySelector(`.player-slot:nth-child(${playerNumber})`);
                if (correctSlot) {
                    correctSlot.classList.add('correct');
                    setTimeout(() => correctSlot.classList.remove('correct'), 600);
                }
            });
            socket.on('roundOver', ({ reason, winner }) => {
                wordInputArea.classList.add('hidden');
                hostDecisionButtons.classList.add('hidden');
                if (winner && synth) {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C5", "16n", now);
                    synth.triggerAttackRelease("E5", "16n", now + 0.1);
                    synth.triggerAttackRelease("G5", "8n", now + 0.2);
                } else if (synth) {
                    synth.triggerAttackRelease("E3", "8n");
                }
                if (recognition) recognition.stop();
                statusText.textContent = winner ? `${reason} | Turun galibi: ${winner}` : reason;
                countdownEl.textContent = '';
                document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('active', 'eliminated'));
                const isHost = myDetails && myDetails.id === currentHostId;
                startButton.classList.toggle('hidden', !isHost);
            });
            socket.on('finalWinner', ({winner, scores}) => {
                wordInputArea.classList.add('hidden');
                if (recognition) recognition.stop();
                updateScoreboard(scores, true);
                countdownEl.textContent = '';
                statusText.innerHTML = `<div class="text-3xl">üèÜ Oyun Bitti! Kazanan: <span class="gold font-black">${winner}</span> üèÜ</div>`;
                const isHost = myDetails && myDetails.id === currentHostId;
                newGameButton.classList.toggle('hidden', !isHost);
                startButton.classList.add('hidden');
                hostDecisionButtons.classList.add('hidden');
            });
            
            socket.on('singlePlayerStarted', () => {
                initialScreen.classList.add('hidden');
                gameContainer.classList.add('hidden');
                singlePlayerContainer.classList.remove('hidden');
                spGameOverScreen.classList.add('hidden');
                spWordInputArea.classList.remove('hidden');
                spTaskArea.classList.remove('hidden');
                updateUsedWords([], true); // Initialize empty used words for single player
            });

            socket.on('singlePlayerTurnUpdate', ({ letter, category, score, timeLeft }) => {
                spLetterEl.textContent = letter;
                spCategoryEl.textContent = category;
                spScoreEl.textContent = score;
                spCountdownEl.textContent = timeLeft;
                spCountdownEl.classList.remove('animate-pulse-white-to-red');
                spWordInput.focus();
            });

            socket.on('singlePlayerCountdown', (timeLeft) => {
                spCountdownEl.textContent = timeLeft >= 0 ? timeLeft : 0;
                if (timeLeft === 0) {
                    spCountdownEl.classList.add('animate-pulse-white-to-red');
                }
            });

            socket.on('singlePlayerGameOver', ({ score }) => {
                spWordInputArea.classList.add('hidden');
                spGameOverScreen.classList.remove('hidden');
                spFinalScoreEl.textContent = score;
                spTaskArea.classList.add('hidden');
                spCountdownEl.textContent = '';
            });

            socket.on('gameError', (message) => alert(message));
            socket.on('dbUpdateSuccess', (message) => {
                statusText.textContent = message;
                setTimeout(() => statusText.textContent = 'Oyun devam ediyor...', 2000);
            });
            socket.on('dbUpdateError', (message) => alert(message));

            function initializeAudio() {
                if(synth) return;
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                synth = new Tone.Synth().toDestination();
            }
            function populateReel(reelContainer, items, clones = 5) {
                const reel = reelContainer.querySelector('.slot-reel');
                reel.innerHTML = '';
                const itemContainer = document.createElement('div');
                for (let i = 0; i < clones; i++) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `slot-item`;
                        div.textContent = item;
                        itemContainer.appendChild(div);
                    });
                }
                reel.appendChild(itemContainer);
            }
            function spinReel(reelContainer, items, finalIndex) {
                const reel = reelContainer.querySelector('.slot-reel');
                const itemHeight = 80;
                const singleSetHeight = items.length * itemHeight;
                reel.style.transition = 'none';
                reel.style.top = `0px`;
                reel.offsetHeight;
                const spinCount = 4;
                const finalPosition = (spinCount * singleSetHeight) + (finalIndex * itemHeight);
                reel.style.transition = 'top 2.5s cubic-bezier(0.25, 1, 0.5, 1)';
                reel.style.top = `-${finalPosition}px`;
            }
            function updatePlayerSlots(players = []) {
                playerSlotsDiv.innerHTML = '';
                for (let i = 1; i <= 8; i++) {
                    const player = players.find(p => p.playerNumber === i);
                    const slot = document.createElement('div');
                    slot.className = 'player-slot p-4 rounded-lg flex flex-col justify-center items-center';
                    if (player) {
                        slot.id = `player-slot-${player.id}`;
                        slot.innerHTML = `<div class="font-bold text-xl">${player.name}</div><div class="text-sm text-gray-400">Oyuncu ${i}</div>`;
                    } else {
                        slot.innerHTML = `<div class="text-gray-500">Bo≈ü Slot</div>`;
                    }
                    playerSlotsDiv.appendChild(slot);
                }
            }
             function updateScoreboard(scores = {}, isGameOver = false) {
                scoreboardDiv.innerHTML = '';
                const sortedScores = Object.entries(scores).sort(([,a],[,b]) => b-a);
                if (sortedScores.length === 0) {
                    scoreboardDiv.innerHTML = '<p class="text-gray-500 text-center">Hen√ºz puan yok.</p>';
                } else {
                    sortedScores.forEach(([name, score], index) => {
                        const rank = index + 1;
                        let rankClass = '';
                        if (isGameOver) {
                            if (rank === 1) rankClass = 'gold';
                            else if (rank === 2) rankClass = 'silver';
                            else if (rank === 3) rankClass = 'bronze';
                        }
                        const scoreEntry = document.createElement('div');
                        scoreEntry.className = `flex justify-between items-center p-2 rounded-md border-2 border-transparent bg-gray-700 ${rankClass}`;
                        scoreEntry.innerHTML = `<div class="flex items-center"><span class="font-bold mr-3 text-lg w-6 text-center">${rank}.</span><span class="font-semibold">${name}</span></div><span class="font-bold text-xl">${score}</span>`;
                        scoreboardDiv.appendChild(scoreEntry);
                    });
                }
            }
            
            function updateUsedWords(usedWords = [], isSinglePlayer = false) {
                const wordsList = isSinglePlayer ? spUsedWordsList : usedWordsList;
                const noWords = isSinglePlayer ? spNoWordsText : noWordsText;
                
                if (usedWords.length === 0) {
                    noWords.style.display = 'block';
                    wordsList.innerHTML = '<p class="text-gray-500 text-sm text-center">Hen√ºz kelime girilmedi</p>';
                } else {
                    noWords.style.display = 'none';
                    wordsList.innerHTML = '';
                    
                    usedWords.forEach((word, index) => {
                        const wordElement = document.createElement('div');
                        wordElement.className = 'flex justify-between items-center py-1 px-2 mb-1 bg-gray-800 rounded text-sm';
                        wordElement.innerHTML = `
                            <span class="text-white font-medium">${word}</span>
                            <span class="text-green-400 text-xs">#${index + 1}</span>
                        `;
                        wordsList.appendChild(wordElement);
                    });
                    
                    // Auto scroll to bottom to show latest word
                    wordsList.scrollTop = wordsList.scrollHeight;
                }
            }
            
            function updatePlayerStatsDisplay(stats) {
                document.getElementById('stat-games-played').textContent = stats.gamesPlayed;
                document.getElementById('stat-games-won').textContent = stats.gamesWon;
                document.getElementById('stat-win-rate').textContent = stats.winRate;
                document.getElementById('stat-longest-streak').textContent = stats.longestWinStreak;
                document.getElementById('stat-current-streak').textContent = stats.currentWinStreak;
                document.getElementById('stat-total-words').textContent = stats.totalCorrectWords;
                document.getElementById('stat-avg-time').textContent = stats.avgResponseTime;
                document.getElementById('stat-fav-category').textContent = stats.favoriteCategory;
                document.getElementById('stat-last-played').textContent = stats.lastPlayed;
                
                // Update most used words
                const mostUsedContainer = document.getElementById('most-used-words');
                if (stats.mostUsedWords.length === 0) {
                    mostUsedContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Hen√ºz kelime verisi yok</p>';
                } else {
                    mostUsedContainer.innerHTML = '';
                    stats.mostUsedWords.forEach(({ word, count }) => {
                        const wordElement = document.createElement('div');
                        wordElement.className = 'bg-gray-800 p-3 rounded-lg text-center';
                        wordElement.innerHTML = `
                            <div class="font-bold text-white">${word}</div>
                            <div class="text-sm text-gray-400">${count} kez</div>
                        `;
                        mostUsedContainer.appendChild(wordElement);
                    });
                }
            }
            
            // Statistics Event Handlers
            showStatsButton.addEventListener('click', () => {
                const playerName = nameInput.value.trim();
                if (!playerName) {
                    alert('ƒ∞statistikleri g√∂rmek i√ßin √∂nce isminizi girin!');
                    return;
                }
                socket.emit('requestPlayerStats', { playerName });
                initialScreen.classList.add('hidden');
                statsScreen.classList.remove('hidden');
            });
            
            closeStatsButton.addEventListener('click', () => {
                statsScreen.classList.add('hidden');
                initialScreen.classList.remove('hidden');
            });
            
            socket.on('playerStatsUpdate', ({ playerName, stats }) => {
                updatePlayerStatsDisplay(stats);
            });
        }
    </script>
</body>
</html>

